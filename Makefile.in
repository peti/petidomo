#
# Petidomo Makefile
#

prefix 		= @prefix@
exec_prefix 	= @exec_prefix@
bindir 		= @bindir@
libexecdir 	= @libexecdir@/petidomo
datadir 	= @datadir@/petidomo
sysconfdir 	= @sysconfdir@
localstatedir 	= @localstatedir@/petidomo

CC		= @CC@
AR		= ar
RANLIB		= @RANLIB@
LEX		= @LEX@
YACC		= @YACC@
SHTOOL          = ./etc/shtool

CFLAGS		= @CFLAGS@
CPPFLAGS	= @CPPFLAGS@ @DEFS@ -DSYSCONFDIR=\"$(sysconfdir)\" -DLIBEXECDIR=\"$(libexecdir)\" \
		  -DDATADIR=\"$(datadir)\" -DLOCALSTATEDIR=\"$(localstatedir)\" \
		 -DBINDIR=\"$(bindir)\"
LDFLAGS		= @LDFLAGS@

OBJS		= acl.o archive.o authen.o config.o generate_cookie.o \
		  filter.o handleacl.o help.o hermes.o index.o io.o listserv.o \
		  mailer.o members.o parsearray.o password.o rfcparse.o \
		  subscribe.o tool.o unsubscribe.o main.o queue_command.o \
	 	  queue_posting.o approve.o address-db.o
LIBS		= librfc822/librfc822.a libmpools/libmpools.a liblists/liblists.a libargv/libargv.a \
		  libconfigfile/libconfigfile.a libtext/libtext.a

FLAGS_TO_PASS	= CC="$(CC)" AR="$(AR)" RANLIB="$(RANLIB)" LEX="$(LEX)" \
		  YACC="$(YACC)" CFLAGS="$(CFLAGS)" \
		  CPPFLAGS="$(CPPFLAGS)" LDFLAGS="$(LDFLAGS)"

.SUFFIXES:
.SUFFIXES:	.c .o

.c.o:
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<

petidomo:	$(OBJS) $(LIBS)
	$(CC) $(OBJS) -o $@ $(LDFLAGS) $(LIBS)

acl.c acl_scan.h:	acl.y
	$(YACC) -d -p acl acl.y
	mv y.tab.c acl.c
	mv y.tab.h acl_scan.h

acl_scan.c:		acl_scan.l acl_scan.h
	$(LEX) -i -Pacl acl_scan.l
	mv lex.acl.c acl_scan.c

acl.c:			acl_scan.c

$(LIBS):
	(cd `echo $@ | sed -e 's@/.*@@'` && $(MAKE) $(FLAGS_TO_PASS))

install:	petidomo
	$(SHTOOL) mkdir -f -p -m 755 $(bindir)
	$(SHTOOL) mkdir -f -p -m 755 $(sysconfdir)
	$(SHTOOL) mkdir -f -p -m 755 $(localstatedir)/lists
	$(SHTOOL) mkdir -f -p -m 755 $(localstatedir)/ack_queue
	$(SHTOOL) mkdir -f -p -m 755 $(datadir)
	$(SHTOOL) mkdir -f -p -m 755 $(libexecdir)
	$(SHTOOL) install -c -s -m 555 petidomo $(bindir)
	$(SHTOOL) install -c -m 644 ../etc/petidomo.conf $(sysconfdir)/petidomo.conf-sample
	$(SHTOOL) install -c -m 644 ../etc/petidomo.acl $(sysconfdir)/petidomo.acl-sample
	$(SHTOOL) install -c -m 444 ../etc/help $(datadir)/help
	$(SHTOOL) install -c -m 555 ../etc/InsertNameInSubject.sh $(libexecdir)
	$(SHTOOL) install -c -m 555 ../etc/pgp-decrypt.sh $(libexecdir)
	$(SHTOOL) install -c -m 555 ../etc/pgp-encrypt.sh $(libexecdir)
	$(SHTOOL) install -c -m 555 ../etc/rfc2369.sh $(libexecdir)

install-testlist:
	$(SHTOOL) mkdir -f -p -m 755 $(localstatedir)/lists/testlist
	$(SHTOOL) install -c -m 644 ../etc/list-config $(localstatedir)/lists/testlist/config
	$(SHTOOL) install -c -m 644 ../etc/list-acl $(localstatedir)/lists/testlist/acl
	@rm -f $(localstatedir)/lists/testlist/list
	$(SHTOOL) install -c -m 644 /dev/null $(localstatedir)/lists/testlist/list

clean distclean realclean::
	@for n in lib*; do (cd $$n && $(MAKE) $@); done

clean::
	rm -f petidomo
	rm -f $(OBJS)
	rm -f acl_scan.c acl_scan.h acl.c

distclean::	clean
	rm -f config.log config.cache config.status Makefile

realclean::	distclean
	rm -f configure

# Dependencies

acl.o: libtext/text.h petidomo.h acl_scan.c acl_scan.h
acl_scan.o: acl_scan.h
archive.o: libtext/text.h petidomo.h
authen.o: libtext/text.h petidomo.h
config.o: libtext/text.h liblists/lists.h libconfigfile/configfile.h
config.o: petidomo.h
filter.o: petidomo.h
generate_cookie.o: petidomo.h
handleacl.o: petidomo.h
help.o: libtext/text.h petidomo.h
hermes.o: libtext/text.h petidomo.h
index.o: libtext/text.h petidomo.h
io.o: petidomo.h
listserv.o: libtext/text.h petidomo.h
mailer.o: libtext/text.h petidomo.h
main.o: libargv/argv.h petidomo.h
members.o: libtext/text.h petidomo.h
parsearray.o: petidomo.h
password.o: petidomo.h
rfcparse.o: librfc822/rfc822.h libtext/text.h petidomo.h
subscribe.o: libtext/text.h petidomo.h
tool.o: libtext/text.h petidomo.h
unsubscribe.o: libtext/text.h petidomo.h
